<mat-stepper [linear]="isLinear" #stepper [orientation]="_tight() ? 'vertical' : orientation()" [(selectedIndex)]="selectedIndex">
    @for (step of steps(); let i = $index; track step) {
        <mat-step [stepControl]="step.control" [label]="step.label" [state]="step.state" [editable]="step.editable ?? true" [optional]="step.optional">
            <ng-template matStepContent>
                @let template = step["_template"];
                <portal [template]="template" (attached)="onAttach(step, $event, i)" (detached)="onDetach(i)"></portal>
                <div style="display: flex; justify-content: end; gap: 1rem; margin-block-start: 1.5rem;">
                    @for (action of step.actions ?? []; track action) {
                        <portal [template]="action"></portal>
                    }
                    <span style="flex: 1"></span>
                    @if (stepper.selectedIndex > 0) {
                        <button mat-stroked-button (click)="prev()">Back</button>
                    }
                    @if (stepper.selectedIndex < steps().length - 1) {
                        <button mat-stroked-button [disabled]="step.control?.disabled || (step.control?.touched && step.control?.invalid)" (click)="next()">Next</button>
                    } @else {
                        <button mat-flat-button [buttonControl]="step.control" (click)="onDone()" color="primary">Done</button>
                    }
                </div>
            </ng-template>
        </mat-step>
    }
</mat-stepper>
