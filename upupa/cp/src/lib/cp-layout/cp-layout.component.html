<main>
    <mat-toolbar class="mat-elevation-z2">
        @let items = sideBarItems();
        @if (items) {
            <button mat-icon-button (click)="drawer().toggle()">
                <mat-icon>reorder</mat-icon>
            </button>
        }
        <img [src]="logo()" class="logo" />
        @for (item of topBarItems(); track $index) {
            @if (item === "spacer") {
                <span class="spacer"></span>
            } @else {
                <portal [component]="item.component"></portal>
            }
        }
        @if (!topBarItems()?.length) {
            <span class="spacer"></span>
        }
        <toolbar-user-menu [commands]="userMenuCommands()" [loginUrl]="loginUrl()"></toolbar-user-menu>
    </mat-toolbar>
    <mat-drawer-container autosize style="flex: 1">
        @if (sideBarItems() | async; as sItems) {
            <mat-drawer class="sidenav" [mode]="sideBarMode()" [opened]="isSidebarOpened()" (openedChange)="onSidebarOpened($event)">
                @for (g of sItems; track i; let i = $index) {
                    @if (g["items"]?.length) {
                        <mat-accordion #accordion class="cp-accordion" [attr.id]="getId(g, i)" displayMode="flat" [authz]="g.action">
                            <mat-expansion-panel #panel [expanded]="hasActiveChild(panel) || g['expanded']" class="mat-elevation-z0">
                                @if (g.text) {
                                    <mat-expansion-panel-header>
                                        <mat-panel-title>
                                            <ng-container *ngTemplateOutlet="iconTemplate; context: { item: g }"></ng-container>
                                            <span>{{ g.text }}</span>
                                        </mat-panel-title>
                                    </mat-expansion-panel-header>
                                }
                                @for (item of g["items"]; track j; let j = $index) {
                                    <ng-container *ngTemplateOutlet="linkTemplate; context: { item: item, index: j, indent: i }"></ng-container>
                                }
                            </mat-expansion-panel>
                        </mat-accordion>
                        <mat-divider [authz]="g.action"></mat-divider>
                    } @else {
                        <ng-container *ngTemplateOutlet="linkTemplate; context: { item: g }"></ng-container>
                    }
                }
            </mat-drawer>
        }
        <router-outlet #outlet="outlet"></router-outlet>
    </mat-drawer-container>
    <ng-content select="footer"></ng-content>
</main>

<ng-template #linkTemplate let-item="item" let-index="index" let-indent="indent">
    <a
        class="cp-item-link"
        [attr.id]="item.name || index"
        [authz]="item.action"
        authAction
        [path]="item.path"
        [action]="item.action"
        [routerLink]="item.link"
        [queryParams]="item.queryParams"
        routerLinkActive="active"
        [ngStyle]="{
            'padding-inline-start': indent ? indent * 0.25 + 'rem' : '12px',
        }"
    >
        <ng-container *ngTemplateOutlet="iconTemplate; context: { item: item }"></ng-container>
        <span style="margin: 0 0.5rem">{{ item.text ?? item.name }}</span>
    </a>
</ng-template>

<ng-template #iconTemplate let-item="item">
    @if (item.icon) {
        <mat-icon>{{ item.icon }}</mat-icon>
    } @else if (item.icon_url) {
        <img [src]="item.icon_url" width="40px" height="40px" />
    }
</ng-template>
