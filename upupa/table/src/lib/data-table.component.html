@let _secondaryRows = secondaryRows() | keyvalue;
<span class="table-header">
    <ng-content select=".table-header"></ng-content>
</span>

<div class="table-container">
    @if (adapter().loading()) {
        <mat-progress-bar style="position: absolute" mode="indeterminate"></mat-progress-bar>
    }
    <table
        #table
        [attr.name]="name()"
        [attr.id]="name()"
        mat-table
        multiTemplateDataRows
        [dataSource]="adapter().normalized()"
        matSort
        [class.sticky-header]="stickyHeader()"
        [matSortDisabled]="adapter().loading()"
        [matSortDirection]="adapter().sort()?.direction"
        [matSortActive]="adapter().sort()?.active"
        (matSortChange)="sort($event)"
        [trackBy]="trackByFn"
        (contentChanged)="contentChanged.emit()"
        [class.loading]="adapter().loading()"
    >
        >
        <ng-container matColumnDef="select" [sticky]="columns()['select']?.sticky === 'start'" [stickyEnd]="columns()['select']?.sticky === 'end'">
            <th mat-header-cell *matHeaderCellDef>
                @if (multiple() === true) {
                    <mat-checkbox
                        (change)="toggleSelectAll()"
                        [checked]="adapter().selection().length >= adapter().normalized()?.length"
                        [indeterminate]="adapter().selection().length > 0 && adapter().selection().length !== adapter().normalized()?.length"
                    >
                    </mat-checkbox>
                }
            </th>
            <td mat-cell *matCellDef="let row">
                <mat-checkbox
                    [disabled]="row.state === 'disabled' || row.state === 'loading'"
                    (click)="$event.stopPropagation()"
                    [checked]="row.selected"
                    (change)="toggleSelection($event, row)"
                ></mat-checkbox>
            </td>
        </ng-container>

        @for (column of _properties | keyvalue; track column.key; let i = $index) {
            <ng-container matColumnDef="{{ column.key }}" [sticky]="column.value?.sticky === 'start'" [stickyEnd]="column.value?.sticky === 'end'">
                <th
                    mat-header-cell
                    *matHeaderCellDef
                    [mat-sort-header]="column.value.sortId || column.key"
                    [arrowPosition]="column.value?.sortArrowPosition || 'after'"
                    [disabled]="column.value?.sortDisabled === true"
                    [class.none]="column.value?.visible === false"
                    [ngStyle]="column.value['style']"
                    [ngClass]="column.value.class"
                >
                    {{ column.value.header || column.key }}
                </th>
                <td
                    mat-cell
                    *matCellDef="let element; let dataIndex = dataIndex"
                    [class.none]="column.value?.visible === false"
                    [ngStyle]="column.value['style']"
                    [ngClass]="column.value.class"
                >
                    <div [ngClass]="column.value.class">
                        @for (template of column.value.template ?? []; track colIdx; let colIdx = $index) {
                            <portal
                                [component]="template['component']"
                                [inputs]="
                                    merge(template.inputs, {
                                        value: element.item | jpointer: column.key,
                                        item: element.item,
                                        element,
                                        row: element,
                                        column,
                                        dataIndex,
                                    })
                                "
                                [injector]="getRowInjector(element)"
                                [outputs]="template['outputs']"
                                [bindings]="template['bindings']"
                                [class]="template['class']"
                            ></portal>
                        } @empty {
                            <cell-template
                                [value]="element.item | jpointer: column.key"
                                [item]="element"
                                [element]="element.item"
                                [column]="column"
                                [dataIndex]="dataIndex"
                            ></cell-template>
                        }
                    </div>
                </td>
            </ng-container>
        }
        <tr mat-header-row *matHeaderRowDef="_columns; sticky: stickyHeader()" [class.selected]="adapter().selection().length > 0"></tr>

        <tr
            mat-row
            *matRowDef="let row; let i = $index; columns: _columns"
            class="{{ rowClass()(row) }}"
            [class.focused]="focusedItem() === row.item"
            [class.selected]="row.selected"
            (click)="onClick(row); toggleExpand(row, i)"
            (touch)="onClick(row)"
            (long-press)="onLongPress(row)"
        ></tr>

        <tr mat-row *matRowDef="let row; columns: _columns; when: isGroup" style="background: #ccc"></tr>

        @let _detailsTemplate = expandableTemplate();
        @let _detailsComponent = expandableComponent();
        @if (expandable() !== "none" && (_detailsTemplate || _detailsComponent)) {
            <ng-container matColumnDef="expandedDetail" [sticky]="columns()['actions']?.sticky === 'start'">
                <td
                    mat-cell
                    *matCellDef="let element; let dataIndex = dataIndex"
                    [attr.colspan]="_columns.length"
                    class="element-detail"
                    [@detailExpand]="expanded[element.key]?.() ? 'expanded' : 'collapsed'"
                >
                    @if (_detailsTemplate) {
                        <ng-container [ngTemplateOutlet]="_detailsTemplate" [ngTemplateOutletContext]="{ element }"></ng-container>
                    } @else {
                        <portal
                            [component]="_detailsComponent.component"
                            [inputs]="
                                merge(_detailsComponent.inputs, {
                                    value: element.item,
                                    item: element.item,
                                    element,
                                    row: element,
                                    dataIndex,
                                })
                            "
                            [injector]="getRowInjector(element)"
                            [outputs]="_detailsComponent['outputs']"
                            [bindings]="_detailsComponent['bindings']"
                            [class]="_detailsComponent['class']"
                        ></portal>
                    }
                </td>
            </ng-container>

            <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="expandable-row" [class.expanded]="expanded[row.key]?.()"></tr>
        }

        @for (column of _secondaryRows; track $index) {
            <ng-container [matColumnDef]="column.key">
                <td
                    mat-cell
                    *matCellDef="let element; let dataIndex = dataIndex"
                    [attr.colspan]="_columns.length"
                    [class.none]="column.value?.visible === false"
                    [ngStyle]="column.value['style']"
                    [ngClass]="column.value.class"
                >
                    <div [ngClass]="column.value.class">
                        @for (template of column.value.template ?? []; track colIdx; let colIdx = $index) {
                            <portal
                                [component]="template['component']"
                                [inputs]="
                                    merge(template.inputs, {
                                        value: element.item | jpointer: column.key,
                                        item: element.item,
                                        element,
                                        row: element,
                                        column,
                                        dataIndex,
                                    })
                                "
                                [injector]="getRowInjector(element)"
                                [outputs]="template['outputs']"
                                [bindings]="template['bindings']"
                                [class]="template['class']"
                            ></portal>
                        } @empty {
                            <cell-template
                                [value]="element.item | jpointer: column.key"
                                [item]="element"
                                [element]="element.item"
                                [column]="column"
                                [dataIndex]="dataIndex"
                            ></cell-template>
                        }
                    </div>
                </td>
            </ng-container>
        }

        @for (secondaryRow of _secondaryRows; track secondaryRow.key; let i = $index) {
            <tr mat-row *matRowDef="let row; columns: [_secondaryRows[0].key]" class="secondary-row"></tr>
        }
    </table>
    @if (adapter().normalized().length === 0) {
        <!-- <ng-content class="empty-state">
        </ng-content> -->
        <div class="no-data">
            @if (noDataImage()) {
                <img style="width: 100%; max-width: 320px" [src]="noDataImage()" alt="no data" />
            }
            <p>{{ noDataMessage() }}</p>
        </div>
    }

    <!-- @if (!adapter().loading()) {
        @if (!items().length) {
            <div id="no-data" style="text-align: center; padding: 2rem">
                @if (noDataImage()) {
                    <img style="width: 100%; max-width: 320px" [src]="noDataImage()" alt="noDataMessage()" />
                }
                <p>{{ noDataMessage() }}</p>
            </div>
        } @else {}
    } -->
</div>

<!-- Hide paginator when total data is lte page size -->
<div class="mat-paginator">
    @let page = adapter().page();
    @let length = page.length ?? 0;
    @let pageSize = page.pageSize ?? adapter().entities().length;
    @let pageIndex = page.pageIndex ?? 0;
    @if (pageIndex > 0 || (showPaginator() && length > pageSize)) {
        <mat-paginator
            [disabled]="adapter().loading() === true"
            [pageIndex]="pageIndex"
            [length]="length"
            [pageSize]="pageSize"
            [pageSizeOptions]="pageSizeOptions()"
            (page)="goto($event)"
            showFirstLastButtons
        ></mat-paginator>
    }
    <!-- a placeholder to prevent layout damage -->
</div>
