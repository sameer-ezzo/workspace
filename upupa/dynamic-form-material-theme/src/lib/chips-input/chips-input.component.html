<mat-form-field [appearance]="appearance()" [floatLabel]="floatLabel()" style="width: 100%">
    @if (label()) {
        <mat-label>{{ label() }}</mat-label>
    }
    <mat-chip-grid #chipGrid [formControl]="control()" [attr.aria-label]="label()">
        @for (item of _value(); track item.key) {
            <mat-chip-row [value]="item.value">
                {{ item.display }}
                <button matChipRemove (click)="remove(item.key)" [attr.aria-label]="'remove ' + item.key">
                    <mat-icon>cancel</mat-icon>
                </button>
            </mat-chip-row>
        }
        <input
            [attr.name]="name()"
            matInput
            [(ngModel)]="text"
            [required]="required()"
            [placeholder]="placeholder()"
            [matChipInputFor]="chipGrid"
            [matAutocomplete]="auto"
            [matChipInputSeparatorKeyCodes]="separatorKeysCodes()"
            (matChipInputTokenEnd)="add($event.value)"
        />
    </mat-chip-grid>

    <mat-autocomplete #auto="matAutocomplete" (optionSelected)="$event.option.value ? select($event.option.value) : undefined">
        @for (opt of this.adapter().normalized(); track opt.key) {
            <mat-option [value]="opt.value">
                @if (opt.image) {
                    <img [src]="opt.image" [attr.alt]="opt.display" />
                }
                <span>{{ opt.display }}</span>
            </mat-option>
        } @empty {
            @if (canAdd() && text()?.length > 1) {
                <mat-option (click)="add(text())"><span>Add</span></mat-option>
            } @else {
                <mat-option disabled>No options</mat-option>
            }
        }
    </mat-autocomplete>
    <mat-error *errors="control().errors; control: control(); let message">{{ message }}</mat-error>
</mat-form-field>
