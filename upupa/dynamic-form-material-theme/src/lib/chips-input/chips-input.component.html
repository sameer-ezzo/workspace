<mat-form-field [appearance]="appearance()" [floatLabel]="floatLabel()" style="width: 100%">
    @if (label()) {
        <mat-label>{{ label() }}</mat-label>
    }
    <mat-chip-grid #chipGrid [formControl]="control()" [attr.aria-label]="label()">
        @for (item of isSelected(); track item.key) {
            <mat-chip-row [class.loading]="adapter().loading()" [value]="item.value" (removed)="unselect([item.value])">
                {{ item.display ?? "..." }}
                <button matChipRemove (click)="unselect([item.value])" [attr.aria-label]="'remove ' + item.display">
                    <mat-icon>cancel</mat-icon>
                </button>
            </mat-chip-row>
        }
        <input
            #textInput
            [attr.name]="name()"
            matInput
            [value]="text()"
            (input)="text.set(textInput.value)"
            [required]="required()"
            [placeholder]="placeholder()"
            [matChipInputFor]="chipGrid"
            [matAutocomplete]="auto"
            [matChipInputSeparatorKeyCodes]="separatorKeysCodes()"
            (matChipInputTokenEnd)="textInput.value?.length ? onAddChip(textInput.value) : null; textInput.value = ''"
        />
    </mat-chip-grid>
    <div matSuffix style="display: flex; align-items: center">
        @if (adapter().loading()) {
            <mat-progress-spinner style="margin: 0.5rem" [diameter]="20" mode="indeterminate"></mat-progress-spinner>
        }
    </div>

    <mat-autocomplete #auto (optionSelected)="select([$event.option.value]); text.set('')" [hideSingleSelectionIndicator]="true">
        @if (autoComplete()) {
            @if (adapter().loading()) {
                <!-- span will hide the checkbox for this option -->
                <span disabled> Loading ...</span>
            } @else {
                @for (item of notSelected(); track item.key) {
                    <mat-option [value]="item.value">
                        @if (item.image) {
                            <img [src]="item.image" [attr.alt]="item.display" />
                        }
                        <span>{{ item.display }}</span>
                    </mat-option>
                } @empty {
                    @if (!canAdd() || !text()?.length) {
                        <mat-option disabled>No options</mat-option>
                    }
                }
                @if (canAdd()) {
                    <mat-option (click)="onAddChip(text())"> <mat-icon>add</mat-icon> <span>Add</span></mat-option>
                }
            }
        }
    </mat-autocomplete>
    <mat-error *errors="control().errors; control: control(); let message">{{ message }}</mat-error>
</mat-form-field>
