<mat-form-field [appearance]="appearance()" [floatLabel]="floatLabel()" style="width: 100%">
    @if (label()) {
        <mat-label>{{ label() }}</mat-label>
    }
    <mat-chip-grid #chipGrid [formControl]="control()" [attr.aria-label]="label()">
        @for (item of selectedNormalized(); track item.key) {
            <mat-chip-row [value]="item.value">
                {{ item.display }}
                <button matChipRemove (click)="deselect(item.value)" [attr.aria-label]="'remove ' + item.key">
                    <mat-icon>cancel</mat-icon>
                </button>
            </mat-chip-row>
        }
        <input
            #input
            [attr.name]="name()"
            matInput
            [value]="text()"
            (input)="text.set(input.value)"
            [required]="required()"
            [placeholder]="placeholder()"
            [matChipInputFor]="chipGrid"
            [matAutocomplete]="auto"
            [matChipInputSeparatorKeyCodes]="separatorKeysCodes()"
            (matChipInputTokenEnd)="add(input.value); input.value = ''"
        />
    </mat-chip-grid>

    <mat-autocomplete #auto (optionSelected)="$event.option.value ? select($event.option.value) : undefined">
        @if(autoComplete()) {
            @if (loading()) {
                <!-- span will hide the checkbox for this option -->
                <span disabled> Loading ...</span>
            } @else {
                @for (item of items(); track $index) {
                    <mat-option [value]="item.value">
                        @if (item.image) {
                            <img [src]="item.image" [attr.alt]="item.display" />
                        }
                        <span>{{ item.display }}</span>
                    </mat-option>
                } @empty {
                    @if (canAdd() && text()?.length > 1) {
                        <mat-option (click)="add(text())"><span>Add</span></mat-option>
                    } @else {
                        <mat-option disabled>No options</mat-option>
                    }
                }
            }
        }
    </mat-autocomplete>
    <mat-error *errors="control().errors; control: control(); let message">{{ message }}</mat-error>
</mat-form-field>
