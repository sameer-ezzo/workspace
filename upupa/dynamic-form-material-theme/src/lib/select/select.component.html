
<mat-form-field [appearance]="appearance()" [floatLabel]="floatLabel()" style="width: 100%">
    @if (label()) {
        <mat-label>{{ label() }}</mat-label>
    }

    @if (multiple()) {
        <mat-select
            #selectInput
            multiple
            [value]="value()"
            (selectionChange)="select(selectInput.value, { clearSelection: true })"
            [formControl]="control()"
            (openedChange)="selectInput.panelOpen ? loadData() : null"
            [compareWith]="compareWithFn"
            [panelClass]="panelClass()"
            [placeholder]="placeholder()"
            [required]="required()"
            [attr.name]="name()"
        >
            @if (showSearch()) {
                <ng-container [ngTemplateOutlet]="searchBoxTemplate"></ng-container>
            }
            @if (adapter().loading()) {
                <!-- span will hide the checkbox for this option -->
                <span disabled> Loading ...</span>
            }

            <div class="selected-wrapper">
                <span>{{ adapter().selection().length }} Selected</span>
                <span style="flex: 1 1 auto"></span>
                <!-- <mat-checkbox [checked]="itemsSource() === 'selected'" (change)="itemsSource.set($event.checked ? 'selected' : 'adapter')" [disabled]="!selected().length"
                    >Show only selected</mat-checkbox
                >-->
            </div>

            @for (item of items(); track item.key) {
                <mat-option [value]="item.value">
                    <ng-container [ngTemplateOutlet]="itemTemplate() ?? defaultItemTemplate" [ngTemplateOutletContext]="{ item: item }"> </ng-container>
                </mat-option>
            } @empty {
                @if (!adapter().loading()) {
                    <span disabled> No items found </span>
                }
            }

            @for (action of actions; track $index) {
                <mat-option (click)="onAction($event, action)">
                    @if (action["icon"]?.length) {
                        <mat-icon>{{ action["icon"] }}</mat-icon>
                    }
                    <span>{{ action.text }}</span>
                </mat-option>
            }
        </mat-select>
    } @else {
        <mat-select
            #selectInput
            [value]="value()"
            (selectionChange)="select(selectInput.value, { clearSelection: true })"
            [formControl]="control()"
            (openedChange)="selectInput.panelOpen ? loadData() : null"
            [compareWith]="compareWithFn"
            [placeholder]="placeholder()"
            [panelClass]="panelClass()"
            [required]="required()"
            [attr.name]="name()"
        >
            @if (showSearch()) {
                <ng-container [ngTemplateOutlet]="searchBoxTemplate"></ng-container>
            }
            @if (adapter().loading()) {
                <mat-option disabled> Loading ... </mat-option>
            }

            @for (item of items(); track item.key) {
                <mat-option [value]="item.value" [disabled]="item.state === 'disabled'">
                    <ng-container [ngTemplateOutlet]="itemTemplate() ?? defaultItemTemplate" [ngTemplateOutletContext]="{ item: item }"> </ng-container>
                </mat-option>
            } @empty {
                @if (!adapter().loading()) {
                    <mat-option disabled> No items found </mat-option>
                }
            }

            @for (action of actions; track i; let i = $index) {
                <mat-option (click)="onAction($event, action)">
                    @if (action["icon"]?.length) {
                        <mat-icon>{{ action["icon"] }}</mat-icon>
                    }
                    <span>{{ action.text }}</span>
                </mat-option>
            }
        </mat-select>
    }

    <div matSuffix style="display: flex; align-items: center">
        @if (adapter().loading()) {
            <mat-progress-spinner style="margin: 0.5rem" [diameter]="20" mode="indeterminate"></mat-progress-spinner>
        }
        @if (value() && !disabled()) {
            <button type="button" style="margin-inline-end: -1rem" mat-icon-button (click)="clearValue($event)">
                <mat-icon>clear</mat-icon>
            </button>
        }
    </div>

    @if (hint()) {
        <mat-hint>{{ hint() }}</mat-hint>
    }

    <mat-error *errors="control().errors; control: control(); let message">{{ message }}</mat-error>
</mat-form-field>

<ng-template #searchBoxTemplate>
    <div class="select-filter-wrapper">
        <mat-icon>search</mat-icon>
        <!-- (input)="$event.stopPropagation()" prevent closing the select -->
        <input
            (input)="$event.preventDefault(); $event.stopPropagation()"
            #filterInput
            [focus]="true"
            [placeholder]="placeholder() ?? ''"
            focusType="select"
            style="flex: 1; border: none; outline: none"
            [formControl]="filterControl"
        />
        @if (filterInput.value.length > 0) {
            <!-- <button type="button" mat-icon-button (click)="$event.stopPropagation(); filterModel.set(''); updateFilter()">
                <mat-icon>clear</mat-icon>
            </button> -->
        }
    </div>
</ng-template>

<ng-template #defaultItemTemplate let-item="item">
    @if (item.image) {
        <img #img style="max-height: 3em; margin-bottom: -16px; margin-inline-end: 10px" [src]="item.image" (error)="img.onerror = null; img.src = ''" />
    }
    <span>{{ item.display }}</span>
</ng-template>
