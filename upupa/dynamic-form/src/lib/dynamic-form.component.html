<form #ngFormRef="ngForm" [formGroup]="form" [name]="name()" [attr.id]="name()" (ngSubmit)="onSubmit($event)">
    <mat-accordion>
        @for (record of fields() | orderedKeyValue; track $index) {
            @let fieldName = record.key;

            <ng-container
                *ngTemplateOutlet="
                    fieldTemplate;
                    context: {
                        fieldName,
                        formGroup: form,
                    }
                "
            ></ng-container>
        }
    </mat-accordion>

    <input type="submit" style="display: none" />
</form>

<ng-template #fieldTemplate let-fieldName="fieldName" let-formGroup="formGroup">
    @let name = fieldName;
    @let control = formGroup.get(fieldName);
    @let fieldRef = control?.fieldRef ?? graph.get("group:" + fieldName);
    @let field = fieldRef.field;
    @let input = field.input;

    @if (input === "fieldset" || input === "object") {
        <fieldset [attr.name]="fieldName" class="{{ input }}-input {{ fieldName }}-container field" [formGroup]="control" [class.hidden]="fieldRef.hidden() === true">
            @if (fieldRef.inputs()?.label) {
                <legend>{{ fieldRef.inputs().label }}</legend>
            }
            <ng-container *ngTemplateOutlet="fieldsetTemplate; context: { formGroup, fieldRef }"></ng-container>
        </fieldset>
    } @else if (input === "group") {
        @switch (field.template) {
            @case ("expansion-panel") {
                <mat-expansion-panel
                    [attr.name]="fieldName"
                    class="{{ input }}-input {{ fieldName }}-container field"
                    [class.hidden]="fieldRef.hidden() === true"
                    [expanded]="fieldRef.inputs().expanded"
                >
                    <mat-expansion-panel-header>
                        <mat-panel-title> {{ fieldRef.inputs().label }} </mat-panel-title>
                    </mat-expansion-panel-header>
                    <ng-container *ngTemplateOutlet="fieldsetTemplate; context: { formGroup, fieldRef }"></ng-container>
                </mat-expansion-panel>
            }
            @default {
                <div [attr.name]="fieldName" class="{{ input }}-input {{ fieldName }}-container field" [class.hidden]="fieldRef.hidden() === true">
                    <ng-container *ngTemplateOutlet="fieldsetTemplate; context: { formGroup, fieldRef }"></ng-container>
                </div>
            }
        }
    } @else if (field.input === "array") {
        <p>Array Field Not Supported</p>
    } @else if (field.input === "page-breaker") {
        <p style="display: none"></p>
    } @else if (field.input === "paragraph") {
        <paragraph
            [attr.name]="fieldName + '-text'"
            class="{{ input }}-input-text {{ fieldName }}-container-text"
            [class.hidden]="fieldRef.hidden() === true"
            [text]="fieldRef.text()"
            [renderer]="fieldRef.inputs()?.['renderer'] || 'markdown'"
        ></paragraph>
    } @else {
        <field [fieldRef]="fieldRef" [formControl]="control"></field>
    }
</ng-template>

<ng-template #icon>
    <mat-icon mat-list-icon color="error">error</mat-icon>
</ng-template>

<ng-template #fieldsetTemplate let-fieldRef="fieldRef" let-formGroup="formGroup">
    @let control = formGroup.get(fieldRef.name) ?? formGroup;
    @let field = fieldRef.field;
    @let input = field.input;

    @if (input === "paragraph" || fieldRef.text()) {
        <paragraph [text]="fieldRef.text()" [renderer]="fieldRef.inputs()?.['renderer'] || 'markdown'"></paragraph>
    }
    @for (record of field.items | orderedKeyValue; track $index) {
        @let _fieldName = record.key;
        <ng-container
            *ngTemplateOutlet="
                fieldTemplate;
                context: {
                    fieldName: _fieldName,
                    formGroup: control,
                }
            "
        ></ng-container>
    }
</ng-template>
