<form [formGroup]="form()" [name]="name()" [attr.id]="name() + '_form'" (ngSubmit)="onSubmit($event)" >
    @for (record of fields() | orderedKeyValue; track $index) {
        @let fieldName = record.key;

        <ng-container
            *ngTemplateOutlet="
                fieldTemplate;
                context: {
                    fieldName,
                    group: form(),
                }
            "
        ></ng-container>
    }

    <input type="submit" style="display: none" />
</form>

<!-- <ng-template #fieldTemplate let-field="field" let-template="template" let-formGroup="form" > -->
<ng-template #fieldTemplate let-fieldName="fieldName" let-group="group">
    @let control = group.get(fieldName);
    @let field = control['field']();
    @let ui = field.ui;
    @let input = field.input;
    @if (field.type === 'fieldset' || field.type === 'array') {
        <fieldset [attr.name]="fieldName" class="{{ input }}-input {{ fieldName }}-container field" [formGroup]="group" [class.hidden]="ui?.hidden === true">
            @if (input === 'paragraph' || field.text) {
                <paragraph [text]="field.text" [renderer]="ui?.inputs?.['renderer'] || 'markdown'"></paragraph>
            }
            @if (ui?.inputs?.label) {
                <legend>{{ ui.inputs.label }}</legend>
            }
            @for (record of field.items | orderedKeyValue; track $index) {
                @let _fieldName = record.key;
                <ng-container
                    *ngTemplateOutlet="
                        fieldTemplate;
                        context: {
                            fieldName: _fieldName,
                            group: control,
                        }
                    "
                ></ng-container>
            }
        </fieldset>
    } @else {
        @switch (input) {
            @case ('page-breaker') {
                <p style="display: none"></p>
            }
            @case ('paragraph') {
                <paragraph
                    [attr.name]="fieldName + '-text'"
                    class="{{ input }}-input-text {{ fieldName }}-container-text"
                    [class.hidden]="ui?.hidden === true"
                    [text]="field.text"
                    [renderer]="ui?.inputs?.['renderer'] || 'markdown'"
                ></paragraph>
            }
            @default {
                <field [name]="fieldName" [field]="field" [formControl]="control" [control]="control"></field>
            }
        }
    }
</ng-template>

<ng-template #icon>
    <mat-icon mat-list-icon color="error">error</mat-icon>
</ng-template>
