<form #formRef="ngForm" (ngSubmit)="onSubmit($event)" [formGroup]="form()" [name]="name()" [ngClass]="class()" [attr.id]="name()">
    @for (record of fields() | orderedKeyValue; track $index) {
        @let fieldName = record.key;

        <ng-container
            *ngTemplateOutlet="
                fieldTemplate;
                context: {
                    fieldName,
                    formGroup: form(),
                }
            "
        ></ng-container>
    }
    <input type="submit" style="display: none" />
</form>

<ng-template #fieldTemplate let-fieldName="fieldName" let-formGroup="formGroup">
    @let control = formGroup.get(fieldName);
    @let fieldRef = control?.fieldRef ?? formGroup["group:" + fieldName];
    @let field = fieldRef.field;
    @let input = field.input;

    @if (input === "fieldset" || input === "object") {
        <fieldset [attr.name]="fieldName" class="{{ input }}-input {{ fieldName }}-container field" [formGroup]="control" [class.hidden]="fieldRef.hidden() === true">
            @if (fieldRef.inputs()?.label) {
                <legend>{{ fieldRef.inputs().label }}</legend>
            }
            <ng-container *ngTemplateOutlet="fieldsetTemplate; context: { formGroup, fieldRef }"></ng-container>
        </fieldset>
    } @else if (input === "form") {
        <field [attr.name]="fieldName" [fieldRef]="fieldRef" [formGroup]="control" [class.hidden]="fieldRef.hidden() === true"></field>
    } @else if (input === "group") {
        @switch (field.template) {
            @case ("expansion-panel") {
                <mat-expansion-panel
                    [attr.name]="fieldName"
                    class="{{ input }}-input {{ fieldName }}-container field {{ field.class }}"
                    [class.hidden]="fieldRef.hidden() === true"
                    [expanded]="fieldRef.inputs().expanded"
                    #panel
                    (load)="fieldRef.attachedComponentRef.set({ instance: panel })"
                >
                    <mat-expansion-panel-header>
                        <mat-panel-title> {{ fieldRef.inputs().label }} </mat-panel-title>
                    </mat-expansion-panel-header>
                    <ng-container *ngTemplateOutlet="fieldsetTemplate; context: { formGroup, fieldRef }"></ng-container>
                </mat-expansion-panel>
            }
            @default {
                <div
                    [attr.name]="fieldName"
                    class="{{ input }}-input {{ fieldName }}-container field {{ field.class }}"
                    [class.hidden]="fieldRef.hidden() === true"
                    #div
                    (load)="fieldRef.attachedComponentRef.set({ instance: div })"
                >
                    <ng-container *ngTemplateOutlet="fieldsetTemplate; context: { formGroup, fieldRef }"></ng-container>
                </div>
            }
        }
    } @else if (field.input === "array") {
        <p>Array Field Not Supported</p>
    } @else if (field.input === "page-breaker") {
        <p style="display: none"></p>
    } @else if (field.input === "paragraph") {
        <paragraph
            [attr.name]="fieldName"
            class="{{ input }}-input {{ fieldName }}-container"
            [class.hidden]="fieldRef.hidden() === true"
            [text]="fieldRef.text()"
            [renderer]="fieldRef.inputs()?.['renderer']"
            #panel
            (load)="fieldRef.attachedComponentRef.set({ instance: panel })"
        ></paragraph>
    } @else {
        <field [attr.name]="fieldName" [fieldRef]="fieldRef" [formControl]="control" [class.hidden]="fieldRef.hidden() === true"></field>
    }
</ng-template>

<ng-template #icon>
    <mat-icon mat-list-icon color="error">error</mat-icon>
</ng-template>

<ng-template #fieldsetTemplate let-fieldRef="fieldRef" let-formGroup="formGroup">
    @let control = formGroup.get(fieldRef.name) ?? formGroup;
    @let field = fieldRef.field;
    @let input = field.input;

    @if (input === "paragraph" || fieldRef.text()) {
        <paragraph [text]="fieldRef.text()" [renderer]="fieldRef.inputs()?.['renderer']" #panel (load)="fieldRef.attachedComponentRef.set({ instance: panel })"></paragraph>
    }
    @for (record of field.items | orderedKeyValue; track $index) {
        @let _fieldName = record.key;
        <ng-container
            *ngTemplateOutlet="
                fieldTemplate;
                context: {
                    fieldName: _fieldName,
                    formGroup: control,
                }
            "
        ></ng-container>
    }
</ng-template>
